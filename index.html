<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>BCTI - Master Memo Final Pro</title>
    <style>
        body { font-family: 'Arial', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        .no-print { 
            background: #fff; padding: 15px; border-bottom: 3px solid #333;
            position: sticky; top: 0; z-index: 100;
            max-height: 80vh; overflow-y: auto;
        }
        .admin-only { display: none; }
        
        .panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
        .control-group { background: #f1f8e9; padding: 8px; border: 1px solid #4caf50; border-radius: 6px; }
        .control-group.blue { background: #e3f2fd; border-color: #2196f3; }
        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 3px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        input[type="text"], input[type="number"] { width: 92%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; }

        .btn-add { background: #2196f3; color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 10px; }
        .btn-admin { background: #455a64; color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .item-entry { border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; position: relative; }
        .btn-del { background: #ff5252; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; position: absolute; right: 0; top: 0; font-size: 10px; }

        .btn-backup { background: #673ab7; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; width: 48%; font-weight: bold; }
        .btn-restore { background: #f57c00; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; width: 48%; font-weight: bold; }

        .memo-page {
            width: 170mm; height: 240mm; background: #fff; margin: 20px auto;
            position: relative; border: 1px dashed #ccc; overflow: hidden;
        }
        #header-wrap, #name-wrap, #row-wrap, #footer-wrap { position: absolute; width: 100%; left: 0; }
        .data-field, .item-row { position: absolute; color: #000; font-weight: bold; font-size: 15px; }
        .item-row { width: 100%; display: flex; align-items: flex-start; }

        .col-sl { position: absolute; left: 15mm; width: 12mm; text-align: center; }
        .col-desc { position: absolute; left: 32mm; width: 60mm; white-space: normal; word-wrap: break-word; line-height: 1.2; }
        .col-dur { position: absolute; left: 95mm; width: 20mm; text-align: center; }
        .col-qty { position: absolute; left: 115mm; width: 15mm; text-align: center; }
        .col-rate { position: absolute; left: 132mm; width: 18mm; text-align: center; }
        .col-amount { position: absolute; left: 152mm; width: 15mm; text-align: right; }

        @media print {
            .no-print { display: none !important; }
            body { background: none; }
            .memo-page { margin: 0; border: none; }
            @page { size: 170mm 240mm; margin: 0; }
        }
    </style>
</head>
<body onload="loadSettings()">

<div class="no-print">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin:0; color:#1a237e;">BCTI - Final Calculation Pro</h3>
        <button id="adminBtn" class="btn-admin" onclick="toggleAdmin()">üîê Admin Setup</button>
    </div>

    <div class="panel-grid">
        <div class="control-group blue">
            <label>üë§ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶ì ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø:</label>
            <input type="text" id="inName" placeholder="‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" oninput="applyAll()">
            <input type="text" id="inAddr" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" oninput="applyAll()">
            <div id="entry-list"></div>
            <button class="btn-add" onclick="addNewItem()">‚ûï ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button onclick="window.print()" style="background:blue; color:white; padding:10px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; width: 100%;">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶Æ‡ßã</button>
        </div>

        <div class="control-group admin-only">
            <label>üõ†Ô∏è Shift (‡¶¨‡¶æ‡¶Æ‡ßá - ‡¶°‡¶æ‡¶®‡ßá):</label>
            Name: <input type="range" id="name-move" min="-20" max="50" value="0" oninput="applyAll()">
            Addr: <input type="range" id="addr-move" min="-20" max="50" value="0" oninput="applyAll()">
            Footer: <input type="range" id="foot-move" min="-30" max="50" value="0" oninput="applyAll()">
            SL: <input type="range" id="sl-move" min="-20" max="20" value="0" oninput="applyAll()">
            Desc: <input type="range" id="desc-move" min="-20" max="50" value="0" oninput="applyAll()">
            Dur: <input type="range" id="dur-move" min="-20" max="30" value="0" oninput="applyAll()">
            Qty: <input type="range" id="qty-move" min="-20" max="30" value="0" oninput="applyAll()">
            Rate: <input type="range" id="rate-move" min="-30" max="30" value="0" oninput="applyAll()">
            Amt: <input type="range" id="amt-move" min="-30" max="30" value="0" oninput="applyAll()">
        </div>

        <div class="control-group admin-only">
            <label>üìè Vertical ‡¶ì ‡¶´‡¶®‡ßç‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤:</label>
            Header: <input type="range" id="h-top" min="0" max="100" value="35" oninput="applyAll()">
            Name/Addr: <input type="range" id="n-top" min="20" max="120" value="48" oninput="applyAll()">
            Table: <input type="range" id="r-top" min="50" max="150" value="72" oninput="applyAll()">
            Row Gap: <input type="range" id="row-gap" min="5" max="25" value="10" oninput="applyAll()">
            Footer: <input type="range" id="f-top" min="150" max="230" value="185" oninput="applyAll()">
            Size (px): <input type="range" id="font-size" min="10" max="25" value="15" oninput="applyAll()">
            
            <button onclick="saveSettings(true)" style="background:green; color:white; padding:10px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; width: 100%; margin: 10px 0;">üíæ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            
            <div style="display: flex; justify-content: space-between; gap: 5px;">
                <button class="btn-backup" onclick="backupData()">üì§ ‡¶´‡ßÅ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</button>
                <button class="btn-restore" onclick="document.getElementById('restoreFile').click()">üì• ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</button>
            </div>
            <input type="file" id="restoreFile" style="display:none" onchange="restoreData(event)">
        </div>
    </div>
</div>

<div class="memo-page" id="memo-container">
    <div id="header-wrap">
        <div class="data-field" style="left: 20mm;">Ref: <span id="outRef"></span></div>
        <div class="data-field" style="left: 130mm;">Date: <span id="outDate"></span></div>
    </div>
    <div id="name-wrap">
        <div id="outNameWrap" class="data-field" style="left: 30mm;"><span id="outName"></span></div>
        <div id="outAddrWrap" class="data-field" style="left: 30mm; top: 8mm;"><span id="outAddr"></span></div>
    </div>
    <div id="row-wrap"></div>
    <div id="footer-wrap">
        <div id="footer-move-container">
            <div class="data-field" style="left: 130mm; width: 30mm; text-align: right;" id="outTotal">0.00</div>
            <div class="data-field" style="left: 35mm; top: 10mm;">In Words: <span id="outWords"></span> Taka Only</div>
        </div>
    </div>
</div>

<script>
    let isAdmin = false;

    function toggleAdmin() {
        if (!isAdmin) {
            let pass = prompt("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (1234):", "");
            if (pass === "1234") {
                isAdmin = true;
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.getElementById('adminBtn').innerText = "üîì Admin Mode";
                document.getElementById('adminBtn').style.background = "#2e7d32";
            } else { alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"); }
        } else {
            isAdmin = false;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.getElementById('adminBtn').innerText = "üîê Admin Setup";
            document.getElementById('adminBtn').style.background = "#455a64";
        }
    }

    function addNewItem(val = {d:'', m:'', q:'', r:''}) {
        const div = document.createElement('div');
        div.className = 'item-entry';
        div.innerHTML = `
            <button class="btn-del" onclick="this.parentElement.remove(); applyAll();">‚úñ</button>
            <input type="text" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" value="${val.d}" oninput="applyAll()">
            <div style="display: flex; gap: 5px;">
                <input type="text" placeholder="‡¶Æ‡ßá‡ßü‡¶æ‡¶¶" value="${val.m}" oninput="applyAll()" style="width: 40%;">
                <input type="number" placeholder="Qty" value="${val.q}" oninput="applyAll()" style="width: 25%;">
                <input type="number" placeholder="Rate" value="${val.r}" oninput="applyAll()" style="width: 35%;">
            </div>
        `;
        document.getElementById('entry-list').appendChild(div);
        applyAll();
    }

    function applyAll() {
        document.getElementById('outName').innerText = document.getElementById('inName').value;
        document.getElementById('outAddr').innerText = document.getElementById('inAddr').value;
        document.getElementById('outDate').innerText = new Date().toLocaleDateString('en-GB');

        const fsz = document.getElementById('font-size').value;
        document.getElementById('header-wrap').style.top = document.getElementById('h-top').value + "mm";
        document.getElementById('name-wrap').style.top = document.getElementById('n-top').value + "mm";
        document.getElementById('row-wrap').style.top = document.getElementById('r-top').value + "mm";
        document.getElementById('footer-wrap').style.top = document.getElementById('f-top').value + "mm";
        
        document.getElementById('outNameWrap').style.transform = `translateX(${document.getElementById('name-move').value}mm)`;
        document.getElementById('outAddrWrap').style.transform = `translateX(${document.getElementById('addr-move').value}mm)`;
        document.getElementById('footer-move-container').style.transform = `translateX(${document.getElementById('foot-move').value}mm)`;

        const slv = document.getElementById('sl-move').value;
        const dsv = document.getElementById('desc-move').value;
        const drv = document.getElementById('dur-move').value;
        const qtv = document.getElementById('qty-move').value;
        const rtv = document.getElementById('rate-move').value;
        const amv = document.getElementById('amt-move').value;
        const rgp = document.getElementById('row-gap').value;

        const rowWrap = document.getElementById('row-wrap');
        rowWrap.innerHTML = "";
        let grandTotal = 0;
        
        document.querySelectorAll('.item-entry').forEach((entry, index) => {
            const inputs = entry.querySelectorAll('input');
            const desc = inputs[0].value;
            const dur = inputs[1].value;
            const qty = parseFloat(inputs[2].value) || 0;
            const rate = parseFloat(inputs[3].value) || 0;
            const total = qty * rate;
            grandTotal += total;

            const row = document.createElement('div');
            row.className = 'item-row';
            row.style.top = (index * rgp) + "mm";
            row.style.fontSize = fsz + "px";
            row.innerHTML = `
                <div class="col-sl" style="transform: translateX(${slv}mm)">${(index + 1).toString().padStart(2, '0')}</div>
                <div class="col-desc" style="transform: translateX(${dsv}mm)">${desc}</div>
                <div class="col-dur" style="transform: translateX(${drv}mm)">${dur}</div>
                <div class="col-qty" style="transform: translateX(${qtv}mm)">${qty || ''}</div>
                <div class="col-rate" style="transform: translateX(${rtv}mm)">${rate || ''}</div>
                <div class="col-amount" style="transform: translateX(${amv}mm)">${total > 0 ? total.toFixed(2) : ''}</div>
            `;
            rowWrap.appendChild(row);
        });
        
        document.getElementById('outTotal').innerText = grandTotal.toFixed(2);
        document.getElementById('outWords').innerText = numberToEnglish(grandTotal);
        document.querySelectorAll('.data-field').forEach(el => el.style.fontSize = fsz + "px");
    }

    function numberToEnglish(n) {
        if (n === 0) return "Zero";
        const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const g = (num) => {
            if (num < 20) return a[num];
            if (num < 100) return b[Math.floor(num / 10)] + (num % 10 !== 0 ? " " + a[num % 10] : "");
            if (num < 1000) return g(Math.floor(num / 100)) + " Hundred" + (num % 100 !== 0 ? " " + g(num % 100) : "");
            if (num < 1000000) return g(Math.floor(num / 1000)) + " Thousand" + (num % 1000 !== 0 ? " " + g(num % 1000) : "");
            return num;
        };
        return g(Math.floor(n));
    }

    function backupData() {
        saveSettings(false); 
        const settings = localStorage.getItem('bcti_master_v31');
        const blob = new Blob([settings], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `BCTI_Backup_Full.json`;
        a.click();
    }

    function restoreData(event) {
        const reader = new FileReader();
        reader.onload = function(e) {
            localStorage.setItem('bcti_master_v31', e.target.result);
            location.reload();
        };
        reader.readAsText(event.target.files[0]);
    }

    function saveSettings(showAlert = true) {
        const items = [];
        document.querySelectorAll('.item-entry').forEach(entry => {
            const ins = entry.querySelectorAll('input');
            items.push({ d: ins[0].value, m: ins[1].value, q: ins[2].value, r: ins[3].value });
        });

        const s = {
            conf: {
                fs: document.getElementById('font-size').value,
                ht: document.getElementById('h-top').value,
                nt: document.getElementById('n-top').value,
                rp: document.getElementById('r-top').value,
                fp: document.getElementById('f-top').value,
                rg: document.getElementById('row-gap').value,
                nm: document.getElementById('name-move').value,
                adm: document.getElementById('addr-move').value,
                fm: document.getElementById('foot-move').value,
                sl: document.getElementById('sl-move').value,
                ds: document.getElementById('desc-move').value,
                dr: document.getElementById('dur-move').value,
                qt: document.getElementById('qty-move').value,
                rt: document.getElementById('rate-move').value,
                am: document.getElementById('amt-move').value
            },
            data: {
                name: document.getElementById('inName').value,
                addr: document.getElementById('inAddr').value,
                items: items
            }
        };
        localStorage.setItem('bcti_master_v31', JSON.stringify(s));
        if(showAlert) alert("‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    function loadSettings() {
        const s = JSON.parse(localStorage.getItem('bcti_master_v31'));
        if(s) {
            const c = s.conf;
            document.getElementById('font-size').value = c.fs || 15;
            document.getElementById('h-top').value = c.ht || 35;
            document.getElementById('n-top').value = c.nt || 48;
            document.getElementById('r-top').value = c.rp || 72;
            document.getElementById('f-top').value = c.fp || 185;
            document.getElementById('row-gap').value = c.rg || 10;
            document.getElementById('name-move').value = c.nm || 0;
            document.getElementById('addr-move').value = c.adm || 0;
            document.getElementById('foot-move').value = c.fm || 0;
            document.getElementById('sl-move').value = c.sl || 0;
            document.getElementById('desc-move').value = c.ds || 0;
            document.getElementById('dur-move').value = c.dr || 0;
            document.getElementById('qty-move').value = c.qt || 0;
            document.getElementById('rate-move').value = c.rt || 0;
            document.getElementById('amt-move').value = c.am || 0;

            document.getElementById('inName').value = s.data.name || "";
            document.getElementById('inAddr').value = s.data.addr || "";
            if(s.data.items && s.data.items.length > 0) {
                s.data.items.forEach(item => addNewItem(item));
            } else { addNewItem(); }
        } else { addNewItem(); }
        applyAll();
    }
</script>
</body>
</html>